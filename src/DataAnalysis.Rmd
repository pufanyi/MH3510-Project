---
title: "DataAnalysis"
author: Pu Fanyi
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
      out_dir <- "../docs/";
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_dir=file.path(dirname(inputFile), out_dir));})
output:
  rmdformats::readthedown:
    self_contained: false
---

## Setup and Load Data

```{r setup, warning=FALSE, message=FALSE}
library(ggplot2)
library(GGally)
library(tidyr)
library(reshape2)
library(latex2exp)
library(gridExtra)
library(ggside)
library(RColorBrewer)


draw <- function(drawing_function, file_path, width = 8, height = 8) {
  # Check if the directory exists
  dir_path <- dirname(file_path)
  if (!dir.exists(dir_path)) {
    stop("Directory does not exist: ", dir_path)
  }

  # Try to create the PDF
  tryCatch(
    {
      pdf(file_path, width = width, height = height)
      drawing_function()
      dev.off()
    },
    error = function(e) {
      message("Error creating PDF: ", e$message)
    }
  )

  # Display the plot
  drawing_function()
}
```

```{r}
columns <- c("Y", "X1", "X2", "X3", "X4", "X5", "X6", "X7")
```

```{r}
file <- "../assets/aadt.txt"
data_raw <- read.table(file, col.names = columns)
data_ori <- data_raw[, c("Y", "X1", "X2", "X3", "X4")]
data <- data_ori
head(data)
```

```{r}
image_folder <- "../assets/images/"
```

## Overview of the data

```{r}
overview_image_path <- file.path(image_folder, "overview")
dir.create(overview_image_path, showWarnings = FALSE)
```

```{r}
# Create separate plots for each variable
plot_Y <- ggplot(data, aes(x = Y)) +
  geom_histogram(aes(y = after_stat(density)), fill = "lightblue", color = "black", bins = 30, alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Distribution of Y") +
  theme_minimal()

plot_X1 <- ggplot(data, aes(x = X1)) +
  geom_histogram(aes(y = after_stat(density)), fill = "lightblue", color = "black", bins = 30, alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Distribution of X1") +
  theme_minimal()

plot_X2 <- ggplot(data, aes(x = X2)) +
  geom_histogram(aes(y = after_stat(density)), fill = "lightblue", color = "black", bins = 30, alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Distribution of X2") +
  theme_minimal()

plot_X3 <- ggplot(data, aes(x = X3)) +
  geom_histogram(aes(y = after_stat(density)), fill = "lightblue", color = "black", bins = 30, alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Distribution of X3") +
  theme_minimal()

# Arrange histograms in 2x2 grid
histogram_grid <- arrangeGrob(
  plot_Y, plot_X1, plot_X2, plot_X3,
  ncol = 2,
  nrow = 2
)
```

```{r fig.width=10, fig.height=5}
# Create pie chart for X4
x4_counts <- table(data$X4)
plot_X4 <- ggplot(data.frame(x4_counts), aes(x = "", y = Freq, fill = Var1)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  labs(
    title = "Distribution of X4",
    fill = "Category"
  ) +
  scale_fill_manual(
    values = c("#FF9999", "#66B2FF"),
    labels = c("yes", "no")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),
    legend.position = "bottom",
    legend.title = element_text(),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
  ) +
  geom_text(
    aes(
      label = paste0(round(100 * Freq / sum(Freq), 1), "%")
    ),
    position = position_stack(vjust = 0.5)
  )

# Combine histogram grid and pie chart vertically
combined_plot <- grid.arrange(
  histogram_grid,
  plot_X4,
  ncol = 2,
  widths = c(3, 1)
)

combined_plot_image_path <- file.path(overview_image_path, "combined_histograms.pdf")
ggsave(combined_plot_image_path, combined_plot, width = 10, height = 5)
```

## Graphic display of the observed data

```{r}
pdf(file.path(image_folder, "overview.pdf"), width = 10, height = 10)
ggpairs(data,
  upper = list(continuous = wrap("points", color = "blue", alpha = 0.5, size = 2)),
  lower = list(continuous = wrap("points", color = "red", alpha = 0.5, size = 2)),
  diag = list(continuous = wrap("densityDiag", fill = "lightblue"))
)
dev.off()
```

We let $y' = \log y$ to fix the skewness of the data.

```{r}
y_prime <- log(data$Y)^2
y_prime_fig <- ggplot(data.frame(y_prime), aes(x = y_prime)) +
  geom_histogram(aes(y = after_stat(density)), fill = "lightblue", color = "black", bins = 30, alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = TeX("Distribution of $y' = \\log^2y$"), x = TeX("$y' = \\log^2y$")) +
  theme_minimal()
y_prime_fig
```

Finally, we replace the original $y$ with $y'$.

```{r}
data$Y <- y_prime
```

```{r}
x1_prime <- sqrt(data$X1)
x1_prime_fig <- ggplot(data.frame(x1_prime), aes(x = x1_prime)) +
  geom_histogram(aes(y = after_stat(density)), fill = "lightblue", color = "black", bins = 30, alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = TeX("Distribution of $x_1' = \\sqrt{x_1}$"), x = TeX("$x_1'=\\sqrt{x_1}$")) +
  theme_minimal()
x1_prime_fig
```

```{r}
data$X1 <- x1_prime
```


```{r fig.width=8, fig.height=3}
# merge graphs
merged_graphs <- grid.arrange(
  y_prime_fig,
  x1_prime_fig,
  ncol = 2,
  widths = c(1, 1)
)

ggsave(file.path(overview_image_path, "transformed_variables.pdf"), merged_graphs, width = 8, height = 3)
```


## Single Variable Analysis

```{r}
slr_output_folder <- file.path(image_folder, "slr")
dir.create(slr_output_folder, showWarnings = FALSE)
```

### X1

```{r}
X1_output_folder <- file.path(slr_output_folder, "X1")
dir.create(X1_output_folder, showWarnings = FALSE)
```


```{r}
# scatter plot
scatter_plot_path <- file.path(X1_output_folder, "scatter_plot.pdf")
scatter_plot_X1 <- ggplot(data, aes(x = x1_prime, y = y_prime)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  labs(title = TeX("Scatter Plot of $y'$ vs. $x_1'$"), x = TeX("$x_1'=\\sqrt{x_1}$"), y = TeX("$y'=\\log^2 y$")) +
  theme_minimal()
ggsave(scatter_plot_path, scatter_plot_X1, width = 8, height = 6)
scatter_plot_X1
```

```{r}
slr_X1 <- lm(y_prime ~ x1_prime, data = data)
summary(slr_X1)
```


```{r fig.width=10, fig.height=4}
# Create the main plot with the residuals
plot_resid_X1 <- ggplot(
  data = data.frame(fitted = fitted(slr_X1), residuals = resid(slr_X1)),
  aes(x = fitted, y = residuals)
) +
  # Add points on top
  geom_point(color = "#1f78b4", alpha = 0.6, size = 2) +
  # Original elements
  labs(
    x = "Fitted values",
    y = "Residuals",
    title = "Residuals vs Fitted"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  scale_fill_viridis_d(option = "C") + # Changed to discrete scale
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed"),
  )

qqplot_X1 <- ggplot(data = data.frame(sample = resid(slr_X1)), aes(sample = sample)) +
  stat_qq(color = "#1f78b4", alpha = 0.6, size = 2) +
  stat_qq_line(color = "#e31a1c", linewidth = 1) +
  labs(
    x = "Theoretical Quantiles",
    y = "Sample Quantiles",
    title = "Normal Q-Q"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed")
  )

x1_fig <- grid.arrange(plot_resid_X1, qqplot_X1, ncol = 2)

ggsave(file.path(X1_output_folder, "residuals_vs_fitted_qqplot.pdf"), x1_fig, width = 10, height = 4)
```

```{r}
aov <- anova(slr_X1)
aov
```

### X2

```{r}
X2_output_folder <- file.path(slr_output_folder, "X2")
dir.create(X2_output_folder, showWarnings = FALSE)
```

```{r}
# scatter plot
scatter_plot_path <- file.path(X2_output_folder, "scatter_plot.pdf")
scatter_plot_X2 <- ggplot(data, aes(x = X2, y = Y)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Scatter Plot of Y vs. X2", x = "X2", y = "Y") +
  theme_minimal()
ggsave(scatter_plot_path, scatter_plot_X2, width = 8, height = 6)
scatter_plot_X2
```

```{r}
slr_X2 <- lm(Y ~ X2, data = data)
summary(slr_X2)
```

```{r fig.width=10, fig.height=4}
# Create the main plot with the residuals
plot_resid_X2 <- ggplot(
  data = data.frame(fitted = fitted(slr_X2), residuals = resid(slr_X2)),
  aes(x = fitted, y = residuals)
) +
  # Add points on top
  geom_point(color = "#1f78b4", alpha = 0.6, size = 2) +
  # Original elements
  labs(
    x = "Fitted values",
    y = "Residuals",
    title = "Residuals vs Fitted"
  ) +
  # geom_smooth(method = "loess", color = "red", size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  scale_fill_viridis_d(option = "C") + # Changed to discrete scale
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed"),
  )

qqplot_X2 <- ggplot(data = data.frame(sample = resid(slr_X2)), aes(sample = sample)) +
  stat_qq(color = "#1f78b4", alpha = 0.6, size = 2) +
  stat_qq_line(color = "#e31a1c", size = 1) +
  labs(
    x = "Theoretical Quantiles",
    y = "Sample Quantiles",
    title = "Normal Q-Q"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed")
  )

x2_fig <- grid.arrange(plot_resid_X2, qqplot_X2, ncol = 2)

ggsave(file.path(X2_output_folder, "residuals_vs_fitted_qqplot.pdf"), x2_fig, width = 10, height = 4)
```

```{r}
aov <- anova(slr_X2)
aov
```


### X3

```{r}
X3_output_folder <- file.path(slr_output_folder, "X3")
dir.create(X3_output_folder, showWarnings = FALSE)
```

```{r}
# scatter plot
scatter_plot_path <- file.path(X3_output_folder, "scatter_plot.pdf")
scatter_plot_X3 <- ggplot(data, aes(x = X3, y = Y)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Scatter Plot of Y vs. X3", x = "X3", y = "Y") +
  theme_minimal()
ggsave(scatter_plot_path, scatter_plot_X3, width = 8, height = 6)
scatter_plot_X3
```

```{r}
slr_X3 <- lm(Y ~ X3, data = data)
summary(slr_X3)
```

```{r}
aov <- anova(slr_X3)
aov
```


### X4

```{r}
X4_output_folder <- file.path(slr_output_folder, "X4")
dir.create(X4_output_folder, showWarnings = FALSE)
```

```{r}
# split data for X4 = 0 and X4 = 1
y_control <- data[data$X4 == 1, "Y"]
y_no_control <- data[data$X4 == 2, "Y"]
```


```{r}
# plot the histograms for both groups in the same plot, length of the bins are not the same, so use density

# Define a custom color palette
custom_colors <- c("#2E86AB", "#A23B72")

# Create enhanced histogram
histogram_path <- file.path(X4_output_folder, "histogram.pdf")
histogram_X4 <- ggplot(data, aes(x = Y, fill = factor(X4))) +
  geom_histogram(
    aes(y = after_stat(density)),
    bins = 30,
    alpha = 0.8,
    color = "white",
    size = 0.2
  ) +
  # Add density curve
  geom_density(
    aes(color = factor(X4)),
    alpha = 0.2,
    size = 1
  ) +
  # Customize labels
  labs(
    title = TeX("Distribution of $y'$ across $x_4$"),
    x = TeX("$y' = \\log^2 y$"),
    y = "Density",
    fill = TeX("Category $x_4$"),
    color = TeX("Density Curve")
  ) +
  # Apply custom theme
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", margin = margin(b = 10)),
    plot.subtitle = element_text(size = 12, color = "gray50", margin = margin(b = 20)),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 10),
    legend.position = "right",
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray90"),
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA)
  ) +
  # Apply custom colors
  scale_fill_manual(values = custom_colors, labels = c("Control", "No Control")) +
  scale_color_manual(values = custom_colors, labels = c("Control", "No Control"))


# Save with higher resolution
ggsave(
  histogram_path,
  histogram_X4,
  width = 8,
  height = 4,
)

# Display plot
histogram_X4
```



We can build the model

$$
\begin{aligned}
y'_{ij} = \theta_i + \epsilon_{ij}, && i \in \{1, 2\}, j \in \left\{1, \cdots, n_i\right\}, && \epsilon_{ij}\sim \mathcal{N}\left(0, \sigma^2\right)
\end{aligned}
$$

```{r}
theta_1 <- mean(y_control)
theta_2 <- mean(y_no_control)
print(paste("theta_1 = ", theta_1))
print(paste("theta_2 = ", theta_2))
```

So

$$
\begin{cases}
  \hat{\theta}_1 = \overline{y_{1\cdot}}\approx 114.10 \\
  \hat{\theta}_2 = \overline{y_{2\cdot}}\approx 70.48
\end{cases}
$$

We build ANOVA table

```{r}
group_y <- c(y_control, y_no_control)
group <- factor(rep(c("control", "no control"), c(length(y_control), length(y_no_control))))
anova_table <- aov(group_y ~ group)
summary(anova_table)
```

## Multiple Linear Regression

### Full Model

```{r}
mlr_output_folder <- file.path(image_folder, "mlr")
dir.create(mlr_output_folder, showWarnings = FALSE)
```

```{r}
mlr <- lm(Y ~ X1 + X2 + X3 + X4, data = data)
summary(mlr)
```

```{r}
predicted <- predict(mlr, data[, c("X1", "X2", "X3", "X4")])
```

```{r, fig.width=5, fig.height=5}
# plot(data$Y, predicted, col = "blue", main = "y vs predicted values")
plot <- ggplot(data, aes(x = Y, y = predicted)) +
  geom_point(color = "blue") +
  labs(title = "y vs predicted values") +
  geom_abline(intercept = 0, slope = 1, color = "red")

file_path <- file.path(mlr_output_folder, "y_vs_predicted_values_full_model.pdf")
ggsave(file_path, plot, width = 5, height = 5)
plot
```



```{r fig.width=10, fig.height=4}
plot_resid_mlr <- ggplot(
  data = data.frame(fitted = fitted(mlr), residuals = resid(mlr)),
  aes(x = fitted, y = residuals)
) +
  geom_point(color = "#1f78b4", alpha = 0.6, size = 2) +
  labs(
    x = "Fitted values",
    y = "Residuals",
    title = "Residuals vs Fitted"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  scale_fill_viridis_d(option = "C") +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed"),
  )

qqplot_mlr <- ggplot(data = data.frame(sample = resid(mlr)), aes(sample = sample)) +
  stat_qq(color = "#1f78b4", alpha = 0.6, size = 2) +
  stat_qq_line(color = "#e31a1c", size = 1) +
  labs(
    x = "Theoretical Quantiles",
    y = "Sample Quantiles",
    title = "Normal Q-Q"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed")
  )

mlr_res_fig <- grid.arrange(plot_resid_mlr, qqplot_mlr, ncol = 2)

ggsave(file.path(mlr_output_folder, "residuals_vs_fitted_qqplot.pdf"), mlr_res_fig, width = 10, height = 4)
```


### Adjusted Full Model

```{r}
data$Y <- data$Y^2
```


```{r}
mlr_output_folder <- file.path(image_folder, "mlr")
dir.create(mlr_output_folder, showWarnings = FALSE)
```

```{r}
mlr <- lm(Y ~ X1 + X2 + X3 + X4, data = data)
summary(mlr)
```

```{r}
predicted <- predict(mlr, data[, c("X1", "X2", "X3", "X4")])
```

```{r, fig.width=5, fig.height=5}
ggplot(data, aes(x = Y, y = predicted)) +
  geom_point(color = "blue") +
  labs(title = "y vs predicted values") +
  geom_abline(intercept = 0, slope = 1, color = "red")
```



```{r fig.width=10, fig.height=4}
plot_resid_mlr <- ggplot(
  data = data.frame(fitted = fitted(mlr), residuals = resid(mlr)),
  aes(x = fitted, y = residuals)
) +
  geom_point(color = "#1f78b4", alpha = 0.6, size = 2) +
  labs(
    x = "Fitted values",
    y = "Residuals",
    title = "Residuals vs Fitted"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  scale_fill_viridis_d(option = "C") +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed"),
  )

qqplot_mlr <- ggplot(data = data.frame(sample = resid(mlr)), aes(sample = sample)) +
  stat_qq(color = "#1f78b4", alpha = 0.6, size = 2) +
  stat_qq_line(color = "#e31a1c", size = 1) +
  labs(
    x = "Theoretical Quantiles",
    y = "Sample Quantiles",
    title = "Normal Q-Q"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed")
  )

mlr_res_fig <- grid.arrange(plot_resid_mlr, qqplot_mlr, ncol = 2)

ggsave(file.path(mlr_output_folder, "residuals_vs_fitted_qqplot_transformed.pdf"), mlr_res_fig, width = 10, height = 4)
```

### Adequacy of the model


```{r}
eliminate_x1_mlr <- lm(Y ~ X2 + X3 + X4, data = data)
eliminate_x2_mlr <- lm(Y ~ X1 + X3 + X4, data = data)
eliminate_x3_mlr <- lm(Y ~ X1 + X2 + X4, data = data)
eliminate_x4_mlr <- lm(Y ~ X1 + X2 + X3, data = data)
```

```{r}
anova(mlr, eliminate_x1_mlr)
```

```{r}
anova(mlr, eliminate_x2_mlr)
```

```{r}
anova(mlr, eliminate_x3_mlr)
```


```{r}
anova(mlr, eliminate_x4_mlr)
```

So we try to eliminate $X_3$.

```{r}
mlr <- eliminate_x3_mlr
```

```{r}
summary(mlr)
```

```{r}
predicted <- predict(mlr, data)
```

```{r, fig.width=5, fig.height=5}
ggplot(data, aes(x = Y, y = predicted)) +
  geom_point(color = "blue") +
  labs(title = "y vs predicted values") +
  geom_abline(intercept = 0, slope = 1, color = "red")
```



```{r fig.width=10, fig.height=4}
plot_resid_mlr <- ggplot(
  data = data.frame(fitted = fitted(mlr), residuals = resid(mlr)),
  aes(x = fitted, y = residuals)
) +
  geom_point(color = "#1f78b4", alpha = 0.6, size = 2) +
  labs(
    x = "Fitted values",
    y = "Residuals",
    title = "Residuals vs Fitted"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  scale_fill_viridis_d(option = "C") +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed"),
  )

qqplot_mlr <- ggplot(data = data.frame(sample = resid(mlr)), aes(sample = sample)) +
  stat_qq(color = "#1f78b4", alpha = 0.6, size = 2) +
  stat_qq_line(color = "#e31a1c", size = 1) +
  labs(
    x = "Theoretical Quantiles",
    y = "Sample Quantiles",
    title = "Normal Q-Q"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray", linetype = "dashed")
  )

mlr_res_fig <- grid.arrange(plot_resid_mlr, qqplot_mlr, ncol = 2)

ggsave(file.path(mlr_output_folder, "reduced_residuals_vs_fitted_qqplot.pdf"), mlr_res_fig, width = 10, height = 4)
```

## Prediction

### Data

```{r}
x1 <- 50000
x2 <- 3
x3 <- 60
x4 <- 2
```

Then we do transformation for every values:

$$
\begin{cases}
x_1' = \sqrt{x_1} \\
x_4' = 2 - x_4
\end{cases}
$$

```{r}
x1 <- sqrt(x1)
x4 <- 2 - x4
```


### Point Estimation

```{r}
y_hat <- predict(mlr, data.frame(X1 = x1, X2 = x2, X3 = x3, X4 = x4))
```

```{r}
y_hat
```
```{r}
exp(y_hat ^ (1/4))
```


We transform back

$$
\hat{y} = \exp\sqrt[4]{\hat{y}'}
$$
```{r}
y_hat <- exp(y_hat ^ (1/4))
```

```{r}
y_hat
```

### Interval Estimation

Let's try to get the 90% interval

```{r}
alpha <- 0.1
interval <- predict(mlr, data.frame(X1 = x1, X2 = x2, X3 = x3, X4 = x4), interval = "confidence", level = 1 - alpha)
interval
```

```{r}
l <- exp(interval[2] ^ (1/4))
r <- exp(interval[3] ^ (1/4))
print(paste("(", l, ", ", r, ")"))
```

